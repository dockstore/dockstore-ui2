<!--
  ~    Copyright 2017 OICR
  ~
  ~    Licensed under the Apache License, Version 2.0 (the "License");
  ~    you may not use this file except in compliance with the License.
  ~    You may obtain a copy of the License at
  ~
  ~        http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~    Unless required by applicable law or agreed to in writing, software
  ~    distributed under the License is distributed on an "AS IS" BASIS,
  ~    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~    See the License for the specific language governing permissions and
  ~    limitations under the License.
  -->

<app-header>
  <mat-icon>search</mat-icon>
  Search
</app-header>
<mat-tab-group
  class="homeComponent no-pagination"
  animationDuration="0ms"
  mat-align-tabs="center"
  [selectedIndex]="selectedIndex$ | async"
  (selectedTabChange)="saveTabIndex($event)"
  [ngClass]="(selectedIndex$ | async) === 0 ? 'workflow-tab-group' : 'tool-tab-group'"
>
  <mat-tab class="browserWorkflowsTab" data-cy="workflows-tab">
    <ng-template mat-tab-label>
      <img class="site-icons-tab m-2" src="../assets/svg/sub-nav/workflow.svg" alt="workflow icon" />
      <b>Workflows</b>
    </ng-template>
    <div class="mat-tab-content"></div>
  </mat-tab>
  <mat-tab class="browserToolsTab" data-cy="tools-tab">
    <ng-template mat-tab-label>
      <img class="site-icons-tab m-2" src="../assets/svg/sub-nav/tool.svg" alt="tool icon" />
      <b>Tools</b>
    </ng-template>
    <div class="mat-tab-content"></div>
  </mat-tab>
</mat-tab-group>

<div class="container search-container">
  <div class="row">
    <div class="col-md-3">
      <div class="pb-3">
        <div fxLayout="row wrap" fxLayoutAlign="space-between center">
          <button fxFlex="1 0 12rem" class="m-1" mat-raised-button color="accent" (click)="accordion.openAll()">
            Expand All<mat-icon>unfold_more</mat-icon>
          </button>
          <button fxFlex="1 0 12rem" class="m-1" mat-raised-button color="accent" (click)="accordion.closeAll()">
            Collapse All<mat-icon>unfold_less</mat-icon>
          </button>
        </div>
        <div>
          <!-- For some reason w-100 doesn't work exactly, using fxFlex instead -->
          <button fxFlex="1 1 auto" mat-raised-button color="accent" (click)="resetFilters()" type="button" class="mx-1">
            Reset Filters
          </button>
        </div>
      </div>
      <app-sidebar
        [(filters)]="filters"
        [(fullyExpandMap)]="fullyExpandMap"
        [(orderedBuckets)]="orderedBuckets"
        [(checkboxMap)]="checkboxMap"
        (uploaded)="updatePermalink()"
        [(sortModeMap)]="sortModeMap"
      >
      </app-sidebar>

      <button mat-raised-button color="accent" (click)="resetFilters()" type="button" class="w-100 my-3">Reset Filters</button>
    </div>
    <div class="col-md-9 containers-rsb" *ngIf="advancedSearchObject$ | async as advancedSearchObject">
      <div class="hits">
        <mat-card *ngIf="searchService.noResults(searchTerm, hits)" class="alert alert-warning text-break">
          Sorry, no matches found for <strong>{{ basicSearchText$ | async }}</strong
          >.
          <span *ngIf="suggestTerm$ | async"
            >Do you mean: <strong class="suggestTerm" (click)="searchSuggestTerm()">{{ suggestTerm$ | async }}</strong
            >?</span
          >
        </mat-card>

        <mde-popover #appPopover="mdePopover" [mdePopoverOverlapTrigger]="false">
          <mat-card class="row">
            <div>Link to this page</div>
            <div class="input-group" style="padding: 5px">
              <input type="text" class="form-control" [value]="shortUrl$ | async" readonly />
              <span class="input-group-btn">
                <button
                  data-cy="copy_button"
                  class="btn btn-default"
                  [ngClass]="{ 'btn-copy': isCopied }"
                  type="button"
                  [cdkCopyToClipboard]="shortUrl$ | async"
                  (cbOnSuccess)="isCopied = true"
                  appSnackbar
                >
                  <mat-icon>file_copy</mat-icon>
                </button>
              </span>
            </div>
          </mat-card>
        </mde-popover>

        <div *ngIf="searchService.hasSearchText(advancedSearchObject, searchTerm, hits) || searchService.hasFilters(filters)">
          <mat-card class="alert alert-info text-break">
            <button
              data-cy="share_button"
              mat-raised-button
              type="button"
              color="primary"
              [mdePopoverTriggerFor]="appPopover"
              mdePopoverTriggerOn="click"
              class="mr-2"
            >
              <fa-icon [icon]="faShareAlt" aria-hidden="true"></fa-icon>
              Share
            </button>

            <span *ngIf="searchService.hasResults(searchTerm, hits)">
              <strong>Search: </strong> contains one of <strong>"{{ basicSearchText$ | async }}"</strong>
            </span>

            <span *ngIf="hasAdvancedSearchText$ | async">
              <strong>Search: </strong>
              <span *ngIf="advancedSearchObject.ANDSplitFilter"
                >contains all of <strong>"{{ aNDSplitFilterText$ | async }}"</strong
                ><span *ngIf="advancedSearchObject.ANDNoSplitFilter || advancedSearchObject.ORFilter || advancedSearchObject.NOTFilter">
                  AND
                </span></span
              >
              <span *ngIf="advancedSearchObject.ANDNoSplitFilter"
                >contains exactly <strong>"{{ aNDNoSplitFilterText$ | async }}"</strong
                ><span *ngIf="advancedSearchObject.ORFilter || advancedSearchObject.NOTFilter"> AND </span></span
              >
              <span *ngIf="advancedSearchObject.ORFilter"
                >contains one of <strong>"{{ oRFilterText$ | async }}"</strong
                ><span *ngIf="advancedSearchObject.NOTFilter"> AND </span></span
              >
              <span *ngIf="advancedSearchObject.NOTFilter"
                >does not contain <strong>"{{ nOTFilterText$ | async }}"</strong></span
              >
            </span>
            <span *ngIf="searchService.hasSearchText(advancedSearchObject, searchTerm, hits) && searchService.hasFilters(filters)"
              >&nbsp;AND
            </span>
            <strong *ngIf="!searchService.hasSearchText(advancedSearchObject, searchTerm, hits) && searchService.hasFilters(filters)"
              >Search:
            </strong>
            <span *ngFor="let key of filterKeys$ | async; let i = index">
              the <strong>{{ friendlyNames.get(key) }}</strong> is
              <span *ngFor="let subBucket of filters.get(key); let j = index">
                <strong>{{ key | mapFriendlyValue: subBucket }}</strong>
                <span *ngIf="j < filters.get(key).size - 1"> OR </span>
              </span>
              <span *ngIf="i < filters.size - 1"> AND </span>
            </span>
          </mat-card>
        </div>
        <mat-card class="alert alert-info" *ngIf="showOverLimit">
          <p>
            <strong>Notice: </strong>Your search has returned greater than {{ query_size - 1 }} results, however only
            {{ query_size - 1 }} results are shown. We recommend that you narrow your search to find more relevant results.
          </p>
        </mat-card>
        <app-search-results></app-search-results>
      </div>
    </div>
  </div>
</div>
