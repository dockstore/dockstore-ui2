<!--
~    Copyright 2018 OICR
~
~    Licensed under the Apache License, Version 2.0 (the "License");
~    you may not use this file except in compliance with the License.
~    You may obtain a copy of the License at
~
~        http://www.apache.org/licenses/LICENSE-2.0
~
~    Unless required by applicable law or agreed to in writing, software
~    distributed under the License is distributed on an "AS IS" BASIS,
~    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
~    See the License for the specific language governing permissions and
~    limitations under the License.
-->
<h4 mat-dialog-title>Register Workflow</h4>
<div mat-dialog-content>
  <div class="alert alert-danger alert-dismissable" role="alert" *ngIf="workflowRegisterError">
    <button type="button" class="close" data-dismiss="alert" (click)="clearWorkflowRegisterError()">
      &times;
    </button>
    <p>
      <span class="glyphicon glyphicon-warning-sign"></span>
      {{workflowRegisterError.message}}
    </p>
    <p class="error-output">{{workflowRegisterError.errorDetails}}</p>
  </div>
  <div *ngIf="refreshMessage; else placeholder">
    <mat-progress-bar mode="indeterminate"></mat-progress-bar>
  </div>
  <ng-template #placeholder>
    <div class="pt-2"></div>
  </ng-template>
  <mat-horizontal-stepper #stepper>
    <ng-template matStepperIcon="edit">
      <mat-icon>done</mat-icon>
    </ng-template>
    <mat-step>
      <ng-template matStepLabel>Workflow storage type</ng-template>
      <p>
        You can write your CWL/WDL and store it on Dockstore.org, or you can register a CWL/WDL/NextFlow from an existing third party repository, such
        as GitHub, Bitbucket, etc.
      </p>
      <div class="modal-body">
        <mat-radio-group [(ngModel)]="selectedOption">
          <mat-radio-button *ngFor="let option of options" [value]="option" [id]="option.value + '-register-workflow-option'">
            {{option.label}}
          </mat-radio-button>
        </mat-radio-group>
      </div>
      <div class="modal-footer">
        <button mat-button color="secondary" (click)="hideModal(); clearWorkflowRegisterError()">
          Close
        </button>
        <button mat-flat-button color="primary" matStepperNext>
          Next
        </button>
      </div>
    </mat-step>
    <mat-step>
      <ng-template matStepLabel>Create a workflow</ng-template>
      <form fxLayout="column" fxLayoutAlign="space-evenly stretch" *ngIf="selectedOption?.value == 0" #registerWorkflowForm="ngForm" name="registerWorkflowForm"
        (submit)="registerWorkflow()" novalidate>
        <mat-form-field class="w-100">
          <mat-select placeholder="Source Code Provider" class="radio-group" [(ngModel)]="workflow.repository" name="repository">
            <mat-option *ngFor="let repository of friendlyRepositoryKeys()" [value]="repository">
              {{repository}}
            </mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field class="w-100">
          <mat-label>Source Code Repository</mat-label>
          <input matInput id="sourceCodeRepositoryInput" name="gitPath" [(ngModel)]="workflow.gitUrl" minlength="3" maxlength="128" [pattern]="validationPatterns.gitPath"
            required matTooltip="Git Repository path." placeholder="e.g. CancerCollaboratory/dockstore-tool-liftover" />
          <!-- TODO: Actually return 3 seperate sets of form error messages depending on the descriptor type selected -->
          <mat-error *ngIf="formErrors.gitPath">{{ formErrors.gitPath }}</mat-error>
        </mat-form-field>
        <mat-radio-group class="w-100 radio-group" position="before" id="descriptorTypeRadioButtons" [(ngModel)]="workflow.descriptorType" name="descriptorTypes"
          (change)="radioButtonChange($event)">
          <mat-label>Descriptor Type: </mat-label>
          <mat-radio-button class="radio-button" *ngFor="let descriptorType of (descriptorLanguages$ | async)" [value]="descriptorType.toLowerCase()">
            {{'descriptor_type' | mapFriendlyValue : descriptorType}}
          </mat-radio-button>
        </mat-radio-group>
        <mat-form-field class="w-100">
          <mat-label>Workflow Path</mat-label>
          <!-- TODO: Unbold these radio buttons (font-weight: normal) -->
          <input matInput placeholder="potato" id="sourceCodeRepositoryWorkflowPathInput" name="workflow_path" [(ngModel)]="workflow.workflow_path" minlength="3"
            maxlength="128" [pattern]="descriptorValidationPattern" required [matTooltip]="Tooltip.workflowPath" placeholder="{{ examplePatterns[workflow.descriptorType] }}"
          />
          <!-- TODO: Actually return 3 seperate sets of form error messages depending on the descriptor type selected -->
          <mat-error *ngIf="formErrors.workflow_path">{{ formErrors.workflow_path }}</mat-error>
        </mat-form-field>
        <mat-form-field class="w-100">
          <mat-label>Test Parameter File Path</mat-label>
          <input matInput name="testParameterFilePath" [(ngModel)]="workflow.defaultTestParameterFilePath" minlength="3" maxlength="128" [pattern]="validationPatterns.testParameterFilePath"
            matTooltip="Relative path to a Test Parameter File in the Git repository." placeholder="e.g. /test.json" />
          <mat-error *ngIf="formErrors.testParameterFilePath">{{ formErrors.testParameterFilePath }} </mat-error>
        </mat-form-field>
        <mat-form-field class="w-100">
          <mat-label>Workflow Name</mat-label>
          <input matInput name="workflowName" [(ngModel)]="workflow.workflowName" maxlength="256" [pattern]="validationPatterns.workflowName" [matTooltip]="Tooltip.workflowName"
            placeholder="e.g. liftover-fast (optional)" />
          <mat-error *ngIf="formErrors.workflowName">{{ formErrors.workflowName }} </mat-error>
        </mat-form-field>
        <div mat-dialog-actions class="pull-right">
          <button mat-button type="button" id="closeRegisterWorkflowModalButton" color="secondary" (click)="hideModal(); clearWorkflowRegisterError()">
            Close
          </button>
          <button id="submitButton" type="submit" mat-flat-button color="primary" [disabled]="!registerWorkflowForm.form.valid || refreshMessage">
            Register Workflow
          </button>
        </div>
      </form>
      <form fxLayout="column" fxLayoutAlign="space-evenly stretch" *ngIf="selectedOption?.value == 1" #registerHostedWorkflowForm="ngForm" name="registerHostedWorkflowForm"
        (ngSubmit)="registerHostedWorkflow()" novalidate>
        <mat-radio-group id="descriptorTypeRadioButtons" position="before" class="radio-group" [(ngModel)]="hostedWorkflow.descriptorType" name="descriptorTypes"
          (change)="radioButtonChange($event)">
          <mat-label>Descriptor Type: </mat-label>
          <mat-radio-button matTooltipPosition="after" [matTooltip]="'descriptor_tooltip' | mapFriendlyValue : descriptorType" *ngFor="let descriptorType of (descriptorLanguages$ | async)" [value]="descriptorType.toLowerCase()">
            {{'descriptor_type' | mapFriendlyValue : descriptorType}}
          </mat-radio-button>
        </mat-radio-group>
        <mat-form-field class="w-100">
          <mat-label>Workflow Name</mat-label>
          <input matInput id="hostedWorkflowName" name="hostedWorkflowName" #hostedWorkflowName="ngModel" [(ngModel)]="hostedWorkflow.name" [pattern]="validationPatterns.workflowName"
            maxlength="256" placeholder="e.g. fastqc" required [matTooltip]="Tooltip.workflowName"/>
          <mat-error *ngIf="hostedWorkflowName?.errors?.pattern">{{validationMessage.workflowName.pattern}}</mat-error>
        </mat-form-field>
        <div mat-dialog-actions class="pull-right">
          <button type="button" mat-button color="secondary" (click)="hideModal(); clearWorkflowRegisterError()">
            Close
          </button>
          <button id="submitButton" type="submit" mat-flat-button color="primary" [disabled]="!registerHostedWorkflowForm.form.valid">
            Register Workflow
          </button>
        </div>
      </form>
    </mat-step>
  </mat-horizontal-stepper>
</div>
