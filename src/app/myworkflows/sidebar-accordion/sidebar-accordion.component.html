<!--
  ~    Copyright 2022 OICR, UCSC
  ~
  ~    Licensed under the Apache License, Version 2.0 (the "License");
  ~    you may not use this file except in compliance with the License.
  ~    You may obtain a copy of the License at
  ~
  ~        http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~    Unless required by applicable law or agreed to in writing, software
  ~    distributed under the License is distributed on an "AS IS" BASIS,
  ~    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~    See the License for the specific language governing permissions and
  ~    limitations under the License.
  -->

<div *ngFor="let sourceObj of sourceControlToWorkflows | keyvalue: defaultOrdering">
  <div *ngIf="sourceObj.value.groupEntryInfo.length" class="sourceTitle">
    <img src="../../../assets/images/registries/{{ sourceObj.value.sourceControlTitle }}.svg" class="mb-2 mr-1" alt="Source Control" />
    {{ sourceObj.value?.sourceControlTitle }}
  </div>

  <mat-accordion multi="true">
    <mat-expansion-panel
      [expanded]="orgObj.expanded"
      class="mat-elevation-z"
      *ngFor="let orgObj of sourceObj.value.groupEntryInfo; trackBy: trackByOrgWorkflowObject"
      [class.tool]="isTool$ | async"
    >
      <mat-expansion-panel-header class="pt-2" [class.tool]="isTool$ | async">
        {{ orgObj?.organization }}
      </mat-expansion-panel-header>

      <mat-tab-group
        mat-stretch-tabs
        [ngClass]="(isTool$ | async) ? 'tool-tab-group' : 'workflow-tab-group'"
        [selectedIndex]="orgObj | selectTab: (workflowId$ | async)"
      >
        <mat-tab label="Published">
          <mat-list class="org-accordion-list">
            <mat-list-item
              *ngFor="let workflowObj of orgObj?.published; trackBy: trackByWorkflowId"
              [ngClass]="{
                selectedWorkflow: (isTool$ | async) === false && (workflowId$ | async) === workflowObj?.id,
                selectedTool: (isTool$ | async) && (workflowId$ | async) === workflowObj?.id
              }"
            >
              <mat-icon class="arrow mat-icon-sm">arrow_forward</mat-icon>
              <a
                class="no-wrap"
                title="{{ workflowObj?.repository + (workflowObj?.workflowName ? '/' + workflowObj?.workflowName : '') }}"
                [routerLink]="'/my-' + (entryType$ | async) + 's/' + workflowObj.full_workflow_path"
              >
                {{ workflowObj?.repository + (workflowObj?.workflowName ? '/' + workflowObj?.workflowName : '') }}
              </a>
            </mat-list-item>
            <mat-list-item *ngIf="!orgObj || orgObj?.published.length === 0">
              <p data-cy="no-published-apptool-message" *ngIf="pageEntryType === EntryType.AppTool" class="text-center size-small">
                No published tools.
              </p>
              <p data-cy="no-published-service-message" *ngIf="pageEntryType === EntryType.Service" class="text-center size-small">
                No published services.
              </p>
              <p data-cy="no-published-workflow-message" *ngIf="pageEntryType === EntryType.BioWorkflow" class="text-center size-small">
                No published workflows.
              </p>
            </mat-list-item>
          </mat-list>
        </mat-tab>
        <mat-tab label="Unpublished">
          <mat-list class="org-accordion-list">
            <mat-list-item
              *ngFor="let workflowObj of orgObj?.unpublished; trackBy: trackByWorkflowId"
              [ngClass]="{
                selectedWorkflow: (isTool$ | async) === false && (workflowId$ | async) === workflowObj?.id,
                selectedTool: (isTool$ | async) && (workflowId$ | async) === workflowObj?.id
              }"
            >
              <mat-icon class="arrow mat-icon-sm">arrow_forward</mat-icon>
              <a
                class="no-wrap"
                title="{{ workflowObj?.repository + (workflowObj?.workflowName ? '/' + workflowObj?.workflowName : '') }}"
                [routerLink]="'/my-' + (entryType$ | async) + 's/' + workflowObj.full_workflow_path"
              >
                {{ workflowObj?.repository + (workflowObj?.workflowName ? '/' + workflowObj?.workflowName : '') }}
              </a>
            </mat-list-item>
            <mat-list-item *ngIf="!orgObj || orgObj?.unpublished.length === 0">
              <p data-cy="no-unpublished-apptool-message" *ngIf="pageEntryType === EntryType.AppTool" class="text-center size-small">
                No unpublished tools.
              </p>
              <p data-cy="no-unpublished-service-message" *ngIf="pageEntryType === EntryType.Service" class="text-center size-small">
                No unpublished services.
              </p>
              <p data-cy="no-unpublished-workflow-message" *ngIf="pageEntryType === EntryType.BioWorkflow" class="text-center size-small">
                No unpublished workflows.
              </p>
            </mat-list-item>
          </mat-list>
        </mat-tab>
      </mat-tab-group>
      <mat-action-row
        *ngIf="
          ((entryType$ | async) === EntryType.BioWorkflow || (entryType$ | async) === EntryType.Tool) &&
          (orgObj.sourceControl.startsWith('github.com') ||
            (!orgObj?.sourceControl.startsWith('dockstore.org') && (entryType$ | async) !== EntryType.Tool))
        "
      >
        <div fxFlex>
          <span fxLayout fxLayoutAlign="start" *ngIf="orgObj.sourceControl.startsWith('github.com')">
            <button
              mat-button
              class="small-mat-btn-skin accent-1-dark small-btn-structure mat-elevation-z mr-1 mt-2 mb-2"
              (click)="openGitHubAppsLogs(orgObj.organization)"
            >
              <img src="../../../assets/svg/git-hub.svg" alt="GitHub app logs" class="pr-2" />
              Apps Logs
            </button>
          </span>
          <span
            fxFlex
            fxLayout
            fxLayoutAlign="end"
            *ngIf="!orgObj?.sourceControl.startsWith('dockstore.org') && (entryType$ | async) !== EntryType.Tool"
          >
            <app-refresh-workflow-organization [orgWorkflowObject]="orgObj"></app-refresh-workflow-organization>
          </span>
        </div>
      </mat-action-row>
    </mat-expansion-panel>
  </mat-accordion>
</div>
